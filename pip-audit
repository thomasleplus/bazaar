#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# Lists pip-installed packages and their last access times

# You can specify which python to use, e.g. PYTHON=python3.12
PYTHON=${PYTHON:-python3}

echo "Using Python interpreter: $($PYTHON --version)"
echo "Collecting package access times..."
echo "--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"
printf "%-25s %-25s %-25s %s\n" "PACKAGE" "VERSION" "LAST ACCESS" "PACKAGE PATH"
echo "--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"

# Loop through all pip-installed packages
$PYTHON -m pip list --format=freeze | sed -e 's/==/=/' | while IFS=$'=' read -r pkg version; do
	# Get package install location
	loc=$(${PYTHON} -m pip show "${pkg}" 2>/dev/null | awk '/Location:/{print $2}')
	if [ -z "${loc}" ]; then
		continue
	fi

	pkg_path="${loc}/${pkg}"

	# Some packages are installed as .dist-info directories instead of pure package dirs
	if [ ! -d "${pkg_path}" ]; then
		pkg_path=$(find "${loc}" -maxdepth 1 -type d -name "${pkg}-*.dist-info" | head -n 1)
	fi

	# Skip if still not found
	if [ ! -d "${pkg_path}" ]; then
		continue
	fi

	# Get last access time in ISO 8601 format
	atime=$(stat -f "%Sa" -t "%Y-%m-%dT%H:%M:%S%z" "${pkg_path}" 2>/dev/null)
	printf "%-25s %-25s %-25s %s\n" "${pkg}" "${version}" "${atime}" "${pkg_path}"
done

echo "--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"
echo "Note: Access times may be inaccurate if your filesystem uses 'noatime'."
